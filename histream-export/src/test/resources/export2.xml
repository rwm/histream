<?xml version="1.0" encoding="UTF-8"?>
<export xmlns="http://sekmi.de/ns/histream/export"
	xmlns:eav="http://sekmi.de/histream/ns/eav-data">
<!-- 
the export is a three step process:

First, the specified concepts are queried from the fact store/database.

Second, groups are specified, a map is built which can be used
to assign class ids to concepts. This map is used to transform the
resulting eav xml to an extended form where all facts are annotated
with their matching class id. This transformation can be done on the
fly for each encounter DOM (see below)

Third, the resulting XML is read and for each encounter, a DOM is 
constructed (and annotated as specified above). For each encounter
the xpath expressions in the lower part of this document are executed
to construct table data.
-->
	<concepts>
		<group class="d_lab">
			<concept id="LOINC:26436-6" />
			<concept id="LOINC:26436-6:NEG" />
		</group>
		<group class="diag">
			<concept wildcard="ICD10:*" />
		</group>
	</concepts>
	
	<patient>
		<column header="pid" xpath="@id"/>
		<column header="birthdate" xpath="eav:birthdate"/>
		<column header="gender" xpath="eav:gender"/>
	</patient>
	<visit>
		<column header="pid" xpath="../@id"/>
		<column header="visit" xpath="@id"/>
		<!-- concepts for the visit table must occur only once
		per visit and may not repeat -->
		<column header="start" xpath="eav:start"/>
		<!-- What is better? -->
		<!-- (a) First column, then concepts with value -->
		<column header="diagnostik_labort_ts" na="NULL" xpath="facts/fact[@class='d_lab']/@start">
			<concept code="LOINC:26436-6"/>
			<concept code="LOINC:26436-6:NEG"/>
			<value type="script">
					<eval>fact.conceptId.substring(6)</eval>
			</value>
		</column>
		<!-- (b) first concepts then columns with value -->
		<group>
			<concept code="LOINC:26436-6"/>
			<concept code="LOINC:26436-6:NEG"/>
			<column header="lab_ts" type="attribute">
				<attribute>start</attribute>
			</column>
			<!-- We want this: 
					6:NEG -> not tested
					6/mod=OPB -> tested non pathological
					6/mod=PB -> tested pathological 
			-->
			<column header="lab_ergebnis" type="attribute">
				<modifier>PB</modifier>
				<attribute>start</attribute>
			</column>
		</group>
	</visit>
	<table id="diagnosen">
		<!-- makes more sense for fact tables to specify
			the list of concepts first. -->
		<concept wildcard="ICD10:*"/>
		<concept code="ICD9:123"/>
		<column header="pid" type="patient-ref"/>
		<column header="visit" type="visit-ref"/>
		<column header="start" type="attribute">
			<attribute>start</attribute>
		</column>
		<column header="primary" type="attribute" na="nein">
			<modifier>fuehrend</modifier>
			<!-- if a modifier element is provided, the property
			 will use the context of that modifier -->
			<constant-value>ja</constant-value>
		</column>
		<column header="text" type="attribute">
			<modifier>originalText</modifier>
			<property>value</property>
		</column>
		<!-- reference sequence from patient -->
		<column header="seq1" type="sequence">
			<sequence ref="seq1"/>
		</column>
	</table>
</export>